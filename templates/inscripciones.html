<!-- templates/inscripciones.html -->

{% extends 'parciales/base.html' %}

{% block titulo %}Inicio{% endblock %}

{% block estilos_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inscripciones.css') }}">
{% endblock %}

{% block contenido %}
<main class="contenedor">
    <h1>Formulario de Inscripción</h1>
    <p>Seleccioná el curso al que querés inscribirte y completá tus datos.</p>

    <form id="form-inscripcion" method="POST" action="{{ url_for('inscripciones.inscribirse') }}">
        <div class="campo">
            <label for="nikname">Curso:</label>
            <select id="nikname" name="nikname" required>
                <option value="" disabled selected>-- Seleccionar opción --</option>
                {% for nik in cursos_por_nik %}
                    <option value="{{ nik }}">{{ nik }}</option>
                {% endfor %}
            </select>

            <label for="horario">Horario:</label>
            <select id="horario" name="horario">
                <option value="" disabled selected>-- Seleccionar opción --</option>
            </select>

            <!-- Campo oculto que siempre guarda el id del curso -->
            <input type="hidden" id="curso_id" name="curso_id">

            <label id="dias-label" class="dias-info" style="margin-top: 1rem; display: none;">
                Días: <span id="dias-texto"></span>
            </label>
        </div>

        <div class="campo">
            <label for="apellido">Apellido/s:</label>
            <input type="text" id="apellido" name="apellido" required>
        </div>

        <div class="campo">
            <label for="nombre">Nombre/s completo/s:</label>
            <input type="text" id="nombre" name="nombre" required>
        </div>

        <div class="campo">
            <label for="dni">DNI (solo números):</label>
            <input type="text" id="dni" name="dni" maxlength="8" required>
        </div>

        <div class="campo">
            <label for="cuil">CUIL N° (solo números):</label>
            <input type="text" id="cuil" name="cuil" maxlength="11" pattern="\d{11}" required>
        </div>

        <div class="campo">
            <label for="fecha_nacimiento">Fecha de nacimiento:</label>
            <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required>
        </div>

        <div class="campo">
            <label for="sexo">Sexo:</label>
            <select id="sexo" name="sexo" required>
                <option value="" disabled selected>-- Seleccionar opción --</option>
                <option value="F">Femenino</option>
                <option value="M">Masculino</option>
                <option value="X">Otro</option>
            </select>
        </div>

        <div class="campo">
            <label for="pais_nac">País de Nacimiento:</label>
            <select id="pais_nac" name="pais_nac" required>
                <option value="" disabled selected>-- Seleccionar opción --</option>
                {% for pais in paises %}
                    <option value="{{ pais.id }}">{{ pais.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="campo">
            <label for="nacionalidad">Nacionalidad:</label>
            <select id="nacionalidad" name="nacionalidad" required>
                <option value="" disabled selected>-- Seleccionar opción --</option>
                {% for pais in paises %}
                    <option value="{{ pais.id }}">{{ pais.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="campo">
            <label for="provincia_nac">Provincia de Nacimiento:</label>
            <select id="provincia_nac" name="provincia_nac">
                <option value="" disabled selected>-- Seleccionar opción --</option>
                {% for provincia in provincias %}
                    <option value="{{ provincia.id }}">{{ provincia.nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="campo">
            <label for="localidad_nac">Lugar de Nacimiento:</label>
            <input type="text" id="localidad_nac" name="localidad_nac">
        </div>

        <div class="campo">
            <label for="direccion">Dirección:</label>
            <input id="direccion" name="direccion" required>
        </div>

        <div class="campo">
            <label for="barrio">Barrio:</label>
            <input type="text" id="barrio" name="barrio">
        </div>

        <div class="campo">
            <label for="telefono">Teléfono:</label>
            <input type="text" id="telefono" name="telefono" required>
        </div>
        
        <div class="campo">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" 
                   pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" 
                   required placeholder="ejemplo@dominio.com">
        </div>

        <div class="campo">
            <label for="estudios">Nivel de estudios alcanzado:</label>
            <select id="estudios" name="estudios" required>
                <option value="" disabled selected>-- Seleccionar opción --</option>
                <option value="primario incompleto">Primario incompleto</option>
                <option value="primario completo">Primario completo</option>
                <option value="secundario incompleto">Secundario incompleto</option>
                <option value="secundario completo">Secundario completo</option>
            </select>
        </div>

        <div class="campo">
            <label for="estado_laboral">Estado Laboral:</label>
            <select id="estado_laboral" name="estado_laboral" required>
                <option value="" disabled selected>-- Seleccionar opción --</option>
                <option value="desempleado">Desempleado</option>
                <option value="empleado">Empleado</option>
            </select>
        </div>

        <div class="campo">
            <label for="cud">¿Posee certificado de discapacidad?:</label>
            <select id="cud" name="cud" required default="NO">
                <option value="" disabled selected>-- Seleccionar opción --</option>
                <option value="Si">Si</option>
                <option value="No">No</option>
            </select>
        </div>

        <div class="campo">
            <label for="telefono_emergencia">Teléfono de Emergencia:</label>
            <input type="text" id="telefono_emergencia" name="telefono_emergencia" required>
        </div>
        
        <button type="submit">Inscribirme</button>
    </form>
</main>
{% endblock %}


{% block scripts_extra %}

    <script id="data-cursos" type="application/json">
        {{ cursos_por_nik | tojson | safe }}
    </script>

    <script>
    const cursosPorNik = JSON.parse(document.getElementById('data-cursos').textContent);
    const nikSelect = document.getElementById('nikname');
    const horarioSelect = document.getElementById('horario');


    document.getElementById('dni').addEventListener('input', function (e) {
        // Eliminar todo lo que no sea dígito
        this.value = this.value.replace(/\D/g, '');

        // Limitar a 8 caracteres
        if (this.value.length > 8) {
            this.value = this.value.slice(0, 8);
        }
    });

    nikSelect.addEventListener('change', function() {
        const nik = this.value;
        const opciones = cursosPorNik[nik] || [];

        // Limpiar horarios
        horarioSelect.innerHTML = '';

        if (opciones.length === 1) {
            const unica = opciones[0];
            const opt = document.createElement('option');
            opt.value = unica.id;
            opt.textContent = `${unica.horario}`;
            horarioSelect.appendChild(opt);
            horarioSelect.disabled = true;
        } else if (opciones.length > 1) {
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = '-- Seleccionar horario --';
            horarioSelect.appendChild(defaultOpt);

            opciones.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op.id;
                opt.textContent = `${op.horario}`;
                horarioSelect.appendChild(opt);
            });
            horarioSelect.disabled = false;
        } else {
            horarioSelect.innerHTML = '<option value="">Sin horarios disponibles</option>';
            horarioSelect.disabled = true;
        }

        const diasLabel = document.getElementById('dias-label');
        const diasTexto = document.getElementById('dias-texto');

        if (opciones.length >= 1) {
            diasTexto.textContent = opciones[0].dias.replace(/,/g, ', ');
            diasLabel.style.display = 'block';
        } else {
            diasTexto.textContent = '';
            diasLabel.style.display = 'none';
        }

    });
    horarioSelect.addEventListener('change', function () {
        const nik = nikSelect.value;
        const opciones = cursosPorNik[nik] || [];
        const horarioSeleccionado = this.value;

        const seleccion = opciones.find(op => op.id == horarioSeleccionado);

        const diasLabel = document.getElementById('dias-label');
        const diasTexto = document.getElementById('dias-texto');

        if (!horarioSeleccionado || horarioSeleccionado === '') {
            diasTexto.textContent = '';
            diasLabel.style.display = 'none';
            return;
        }

        if (seleccion && seleccion.dias) {
            diasTexto.textContent = seleccion.dias.replace(/,/g, ', ');
            diasLabel.style.display = 'block';
        } else {
            diasTexto.textContent = '';
            diasLabel.style.display = 'none';
        }
    });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const paisSelect = document.getElementById("pais_nac");
            const provinciaSelect = document.getElementById("provincia_nac");
            const localidadInput = document.getElementById("localidad_nac");

            paisSelect.addEventListener("change", function() {
                const seleccionado = paisSelect.options[paisSelect.selectedIndex].text.toLowerCase();

            if (seleccionado === "argentina") {
                provinciaSelect.disabled = false;
                provinciaSelect.required = true;
                provinciaSelect.classList.remove("disabled");

                localidadInput.disabled = true;
                localidadInput.required = false;
                localidadInput.value = "";
                localidadInput.placeholder = "No requerido (solo para extranjeros)";
                localidadInput.classList.add("disabled");
            } else {
                provinciaSelect.disabled = true;
                provinciaSelect.required = false;
                provinciaSelect.value = "";
                provinciaSelect.placeholder = "No requerido (solo para argentinos)";
                provinciaSelect.classList.add("disabled");

                localidadInput.disabled = false;
                localidadInput.required = true;
                localidadInput.classList.remove("disabled");
            }
        });
    });
    </script>
{% endblock %}

